
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>BLOCK ADVENTURE</title>
    <style>
        body { 
            margin: 0; overflow: hidden; background-color: #111;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none; -webkit-user-select: none; touch-action: none;
        }
        
        /* --- UI LAYERS --- */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .hidden { display: none !important; }
        
        /* --- GAME HUD --- */
        #coin-counter {
            position: absolute; top: 20px; left: 20px;
            font-size: 24px; font-weight: bold; color: #FFD700;
            text-shadow: 2px 2px 0 #000; display: flex; align-items: center; gap: 10px;
        }
        .stud-icon { width: 20px; height: 20px; background: #C0C0C0; border-radius: 50%; border: 2px solid #fff; }
        
        /* BOSS HUD */
        #boss-hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px;
        }
        .heart {
            width: 30px; height: 30px; background: red;
            transform: rotate(45deg); position: relative;
            box-shadow: 0 0 5px #000; transition: background 0.3s;
        }
        .heart::before, .heart::after {
            content: ""; width: 30px; height: 30px; background: inherit;
            border-radius: 50%; position: absolute;
        }
        .heart::before { top: -15px; left: 0; }
        .heart::after { top: 0; left: -15px; }
        .heart-dead { background: #333 !important; }

        /* PAUSE BUTTON - Top Right */
        #pause-btn {
            position: absolute; top: 20px; right: 20px;
            background: #333; color: white; border: 2px solid white;
            padding: 10px 20px; font-weight: bold; cursor: pointer; pointer-events: auto;
            border-radius: 5px; font-size: 16px; z-index: 20;
        }

        /* POPUP TEXT (Interact/Info) */
        #interact-prompt {
            position: absolute; top: 30%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: #FFF; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; font-size: 18px; 
            border: 2px solid #FFD700; display: none; text-align: center;
        }

        /* --- MENUS --- */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; pointer-events: auto; z-index: 50;
        }
        #level-popup {
            position: absolute; bottom: 40%; left: 50%; transform: translateX(-50%);
            background: #fff; color: #333; padding: 20px; border-radius: 15px;
            text-align: center; border: 5px solid #3498db; pointer-events: auto; width: 280px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        button.game-btn {
            padding: 12px 24px; font-size: 20px; background: #e74c3c; color: white; border: none;
            border-bottom: 4px solid #c0392b; cursor: pointer; margin: 10px; border-radius: 8px;
            font-family: inherit; font-weight: bold;
        }
        button.game-btn:active { border-bottom: none; transform: translateY(4px); }
        button.secondary { background: #7f8c8d; border-bottom-color: #636e72; }

        /* --- CONTROLS (BOTTOM) --- */
        #mobile-controls {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 180px;
            pointer-events: none; z-index: 40;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 20px 20px 20px; box-sizing: border-box;
        }
        .ctrl-btn {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 24px; pointer-events: auto; user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .ctrl-btn:active { background: rgba(255, 255, 255, 0.4); transform: scale(0.95); }

        /* Left Side: D-Pad */
        .d-pad-container { position: relative; width: 140px; height: 150px; margin-bottom: -500px; }
        #btn-up { position: absolute; top: 0; left: 45px; width: 50px; height: 50px; }
        #btn-down { position: absolute; bottom: 0; left: 45px; width: 50px; height: 50px; }
        #btn-left { position: absolute; top: 45px; left: 0; width: 50px; height: 50px; }
        #btn-right { position: absolute; top: 45px; right: 0; width: 50px; height: 50px; }

        /* Right Side: Action & Jump */
        .action-container { display: flex; gap: 20px; margin-bottom: -500px; align-items: flex-end; }
        #btn-jump { 
            width: 70px; height: 70px; border-radius: 50%; 
            background: rgba(52, 152, 219, 0.4); border-color: #3498db;
            font-size: 20px; font-weight: bold;
        }
        #btn-action {
            width: 90px; height: 90px; border-radius: 50%;
            background: rgba(231, 76, 60, 0.4); border-color: #e74c3c;
            font-size: 18px; font-weight: bold; /* Smaller font for text */
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div id="game-ui" class="ui-layer">
        <div id="coin-counter"><div class="stud-icon"></div> x <span id="score">0</span></div>
        
        <div id="boss-hud" class="hidden">
            <div id="heart1" class="heart"></div>
            <div id="heart2" class="heart"></div>
            <div id="heart3" class="heart"></div>
        </div>

        <button id="pause-btn">||</button>
        <div id="interact-prompt"></div>
        <div id="level-popup" class="hidden">
            <h2 id="popup-title">LEVEL TITLE</h2>
            <p id="popup-desc">Desc</p>
            <button class="game-btn" id="play-level-btn">PLAY</button>
            <button class="game-btn secondary" id="close-popup-btn">CLOSE</button>
        </div>
    </div>

    <div id="mobile-controls" class="ui-layer">
        <div class="d-pad-container">
            <div class="ctrl-btn" id="btn-up">▲</div>
            <div class="ctrl-btn" id="btn-left">◄</div>
            <div class="ctrl-btn" id="btn-right">►</div>
            <div class="ctrl-btn" id="btn-down">▼</div>
        </div>
        <div class="action-container">
            <div class="ctrl-btn" id="btn-jump">JUMP</div>
            <div class="ctrl-btn" id="btn-action">ACTION</div>
        </div>
    </div>

    <div id="pause-screen" class="overlay-screen hidden">
        <h1>PAUSED</h1>
        <button class="game-btn" id="resume-btn">RESUME</button>
        <button class="game-btn secondary" id="home-btn">MAIN MENU</button>
    </div>

    <div id="win-screen" class="overlay-screen hidden">
        <h1 style="color: #FFD700;">COMPLETE!</h1>
        <button class="game-btn" id="replay-btn">REPLAY</button>
        <button class="game-btn secondary" id="win-home-btn">MAIN MENU</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- ENGINE VARS ---
        let renderer, camera, scene;
        let gameState = 'menu'; 
        let currentLevel = 0;
        let score = parseInt(localStorage.getItem('blockyScoreV6')) || 0;

        // --- PHYSICS VARS ---
        let player, playerVelY = 0, isGrounded = false;
        const GRAVITY = -0.025, JUMP_FORCE = 0.6, SPEED = 0.25;
        let colliders = [], breakables = [], coins = [], interactables = [];
        let particles = [];
        let menuPads = [];
        let guideArrow = null; // The floating arrow

        // --- BOSS VARS ---
        let boss = null;
        let bossHP = 3;
        let bossInvincibleTimer = 0;
        let playerInvincibleTimer = 0;

        // --- PLAYER STATE ---
        let hasHammer = false;
        let hasKey = false;
        let isPaused = false;
        
        // --- INPUTS ---
        const keys = { w:0, a:0, s:0, d:0, jump:0, action:0 };

        init();

        function init() {
            // Setup Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);

            // Bind UI
            document.getElementById('score').innerText = score;
            bindBtn('play-level-btn', () => startGame(window.selectedLevel));
            bindBtn('close-popup-btn', () => document.getElementById('level-popup').classList.add('hidden'));
            bindBtn('pause-btn', togglePause);
            bindBtn('resume-btn', togglePause);
            bindBtn('home-btn', loadMainMenu);
            bindBtn('win-home-btn', loadMainMenu);
            bindBtn('replay-btn', () => startGame(currentLevel));

            setupControls();
            loadMainMenu();
            animate();
        }

        function bindBtn(id, fn) {
            document.getElementById(id).addEventListener('click', fn);
        }

        // ================= WORLD BUILDER =================

        function resetScene() {
            scene = new THREE.Scene();
            colliders = []; breakables = []; coins = []; interactables = []; particles = []; menuPads = [];
            hasHammer = false; hasKey = false; isPaused = false;
            guideArrow = null; boss = null;
            
            // Lights
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const dl = new THREE.DirectionalLight(0xffffff, 0.8);
            dl.position.set(20, 40, 20); dl.castShadow = true;
            dl.shadow.mapSize.set(1024, 1024);
            scene.add(dl);

            createPlayer();
            scene.add(player);
        }

        function loadMainMenu() {
            gameState = 'menu';
            resetScene();
            scene.background = new THREE.Color(0x87CEEB);
            document.getElementById('pause-screen').classList.add('hidden');
            document.getElementById('win-screen').classList.add('hidden');
            document.getElementById('level-popup').classList.add('hidden');
            document.getElementById('boss-hud').classList.add('hidden');

            // Ground
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(80, 80), new THREE.MeshStandardMaterial({ color: 0x2ecc71 }));
            ground.rotation.x = -Math.PI/2; scene.add(ground);

            // Walls
            const brown = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            createWall(80, 15, 2, 0, 7.5, -40, true, brown);  
            createWall(80, 15, 2, 0, 7.5, 40, false);        
            createWall(2, 15, 80, -40, 7.5, 0, true, brown); 
            createWall(2, 15, 80, 40, 7.5, 0, true, brown);  

            // Pads
            createPad(-15, 0, 1, "LEVEL 1", "Break the wall!");
            createPad(0, 0, 2, "LEVEL 2", "Cave Puzzle");
            createPad(15, 0, 3, "THE RING", "Boss Fight!");

            // Decor
            for(let i=0; i<20; i++) createPlant((Math.random()-0.5)*70, (Math.random()-0.5)*70);

            player.position.set(0,0,25);
        }

        function startGame(lvl) {
            currentLevel = lvl;
            gameState = 'playing';
            resetScene();
            document.getElementById('level-popup').classList.add('hidden');
            document.getElementById('win-screen').classList.add('hidden');
            document.getElementById('boss-hud').classList.add('hidden');

            if(lvl === 1) buildLevel1();
            if(lvl === 2) buildLevel2();
            if(lvl === 3) buildLevel3();
        }

        function buildLevel1() {
            scene.background = new THREE.Color(0x2c3e50);
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(50, 50), new THREE.MeshStandardMaterial({ color: 0x7f8c8d }));
            ground.rotation.x = -Math.PI/2; scene.add(ground);
            
            // Box Room
            createWall(2, 12, 42, -21, 6, 0, true);
            createWall(2, 12, 42, 21, 6, 0, true);
            createWall(42, 12, 2, 0, 6, 21, false); 
            createWall(15, 12, 2, -12.5, 6, -20, true);
            createWall(15, 12, 2, 12.5, 6, -20, true);
            createWall(10, 2, 2, 0, 11, -20, true);

            // Breakable Wall
            const w = createWall(10, 10, 2, 0, 5, -20, true, new THREE.MeshStandardMaterial({color:0xD2B48C}));
            w.userData = { type: 'smashWall', hp: 1 };
            interactables.push(w);

            // Crates
            createCrate(10, 0, 10, true); // Hammer inside
            for(let i=0; i<5; i++) createCrate((Math.random()-0.5)*30, 0, (Math.random()-0.5)*30);

            player.position.set(0,0,15);
        }

        function buildLevel2() {
            scene.background = new THREE.Color(0x1a1a1a);
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(80, 80), new THREE.MeshStandardMaterial({ color: 0x333333 }));
            ground.rotation.x = -Math.PI/2; scene.add(ground);

            const gray = new THREE.MeshStandardMaterial({color:0x444444});
            createWall(2, 20, 80, -40, 10, 0, true, gray);
            createWall(2, 20, 80, 40, 10, 0, true, gray);
            createWall(80, 20, 2, 0, 10, -40, true, gray);
            createWall(80, 20, 2, 0, 10, 40, false); 

            // Puzzle Area
            createCrate(-35, 0, -35, false, true); // UNBREAKABLE
            createCrate(-35, 2, -35, false, true);
            createCrate(-32, 0, -35, false, true);
            
            // Key
            createItem('key', -35, 4.5, -35, 0xFFFF00);
            
            // Lever
            const lever = new THREE.Group();
            const base = new THREE.Mesh(new THREE.BoxGeometry(1,0.2,1), new THREE.MeshStandardMaterial({color:0x888}));
            const stick = new THREE.Mesh(new THREE.BoxGeometry(0.2,2,0.2), new THREE.MeshStandardMaterial({color:0xFF0000}));
            stick.position.y=1;
            lever.add(base, stick); lever.position.set(0,0,0);
            scene.add(lever);
            lever.userData = { type: 'lever', active: false, stick: stick };
            interactables.push(lever);

            // Platform
            const plat = createWall(6, 1, 6, 0, -10, -20, true, new THREE.MeshStandardMaterial({color:0x00FF00}));
            plat.userData.isPlatform = true;

            // Finish
            createWall(6, 12, 6, 0, 6, -35, true, gray); 
            createItem('finish', 0, 13, -35, 0x00FFFF);

            spawnCoin(30, 2, -30, 1000, 0x0000FF, false); 
            
            // Unbreakable Boxes Top Left
            createCrate(-30, 0, -30, false, true);
            createCrate(-28, 0, -32, false, true);
            createCrate(-32, 0, -28, false, true);
            createCrate(-30, 2, -30, false, true);

            for(let i=0; i<8; i++) {
                let rx = (Math.random()-0.5)*50;
                let rz = (Math.random()-0.5)*50;
                if(rx < -20 && rz < -20) continue; 
                createCrate(rx, 0, rz);
            }

            player.position.set(0,0,30);
        }

        function buildLevel3() {
            scene.background = new THREE.Color(0x000000);
            // Floor
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(30, 30), new THREE.MeshStandardMaterial({ color: 0x5D4037 }));
            ground.rotation.x = -Math.PI/2; scene.add(ground);

            // Dark Brown Walls - Small Box
            const darkBrown = new THREE.MeshStandardMaterial({ color: 0x3E2723 });
            createWall(2, 10, 30, -15, 5, 0, true, darkBrown); // Left
            createWall(2, 10, 30, 15, 5, 0, true, darkBrown); // Right
            createWall(30, 10, 2, 0, 5, -15, true, darkBrown); // Back
            createWall(30, 10, 2, 0, 5, 15, false); // Front (Invisible)

            // Setup Boss
            createBoss(0, 0, -10);
            
            // Setup UI
            bossHP = 3;
            document.getElementById('boss-hud').classList.remove('hidden');
            document.getElementById('heart1').classList.remove('heart-dead');
            document.getElementById('heart2').classList.remove('heart-dead');
            document.getElementById('heart3').classList.remove('heart-dead');

            player.position.set(0,0,10);
        }

        // ================= OBJECT CREATION =================

        function spawnArrow(x, y, z) {
            if(guideArrow) scene.remove(guideArrow);
            
            const g = new THREE.Group();
            // Cone pointing down
            const cone = new THREE.Mesh(new THREE.ConeGeometry(1, 2, 8), new THREE.MeshBasicMaterial({color: 0x0000FF}));
            cone.rotation.x = -Math.PI; // point down
            g.add(cone);
            
            g.position.set(x, y+4, z);
            scene.add(g);
            guideArrow = g;
        }

        function createWall(w, h, d, x, y, z, visible, mat) {
            const m = visible ? (mat || new THREE.MeshStandardMaterial({color:0x7f8c8d})) : new THREE.MeshBasicMaterial({visible:false});
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), m);
            mesh.position.set(x,y,z);
            if(visible) mesh.receiveShadow = true;
            scene.add(mesh);
            colliders.push(mesh);
            return mesh;
        }

        function createCrate(x, y, z, isSpecial=false, isUnbreakable=false) {
            const color = isUnbreakable ? 0x555555 : (isSpecial ? 0xd35400 : 0x8B4513);
            const mat = new THREE.MeshStandardMaterial({color: color});
            if(isUnbreakable) { mat.roughness = 0.4; mat.metalness = 0.8; }

            const mesh = new THREE.Mesh(new THREE.BoxGeometry(2,2,2), mat);
            mesh.position.set(x, y+1, z); mesh.castShadow = true;
            mesh.userData = { type: 'crate', special: isSpecial, hp: 1, unbreakable: isUnbreakable };
            
            scene.add(mesh);
            colliders.push(mesh);
            if(!isUnbreakable) breakables.push(mesh);
        }

        function createPlant(x, z) {
            if(Math.abs(x)<10 && Math.abs(z)<5) return; 
            const g = new THREE.Group();
            const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,1), new THREE.MeshStandardMaterial({color:0x006400}));
            stem.position.y=0.5;
            const head = new THREE.Mesh(new THREE.DodecahedronGeometry(0.5), new THREE.MeshStandardMaterial({color: Math.random()>0.5?0xFF69B4:0xFFFF00}));
            head.position.y=1;
            g.add(stem, head); g.position.set(x,0,z);
            g.userData = { type: 'plant' };
            scene.add(g);
            breakables.push(g);
        }

        function createPad(x, z, id, title, desc) {
            const pad = new THREE.Mesh(new THREE.CylinderGeometry(3,3,0.2), new THREE.MeshStandardMaterial({color:0x9b59b6}));
            pad.position.set(x, 0.1, z);
            pad.userData = { isPad: true, id: id, title: title, desc: desc };
            scene.add(pad);
            menuPads.push(pad);
        }

        function createItem(type, x, y, z, color) {
            const geo = type==='key' ? new THREE.TorusGeometry(0.5,0.1) : new THREE.OctahedronGeometry(1);
            const m = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({color:color}));
            m.position.set(x,y,z);
            m.userData = { type: type, pickup: true };
            scene.add(m);
            interactables.push(m);
            return m;
        }

        function spawnCoin(x, y, z, val=10, col=0xFFD700, usePhysics=false) {
            const c = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,0.1,16), new THREE.MeshPhongMaterial({color:col}));
            c.rotation.x = 1.57; c.position.set(x,y,z);
            let velocity = new THREE.Vector3(0,0,0);
            if(usePhysics) {
                velocity.set((Math.random() - 0.5) * 0.4, Math.random() * 0.4 + 0.2, (Math.random() - 0.5) * 0.4);
                c.rotation.set(Math.random(), Math.random(), Math.random());
            }
            c.userData = { value: val, isCoin: true, velocity: velocity, physics: usePhysics };
            scene.add(c);
            coins.push(c);
        }

        function createPlayer() {
            player = new THREE.Group();
            const mat = c => new THREE.MeshStandardMaterial({color:c});
            
            // TALLER PLAYER MODS
            // Body (Taller: 1.5 -> 1.8)
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 1.8, 0.8), mat(0x333)); 
            body.position.y = 1.4; // Raised up

            // Head
            const headGroup = new THREE.Group();
            const headMesh = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), mat(0xf1c40f));
            const hair = new THREE.Mesh(new THREE.BoxGeometry(1.3, 0.3, 1.3), mat(0x4B3621)); // Dark Brown
            hair.position.y = 0.65;
            headGroup.add(headMesh, hair);
            headGroup.position.y = 2.9; // Higher neck

            // Legs (Taller: 0.8 -> 1.2)
            const legGeo = new THREE.BoxGeometry(0.5, 1.2, 0.5);
            const legL = new THREE.Mesh(legGeo, mat(0x2c3e50));
            legL.position.set(-0.4, 0.6, 0);
            const legR = new THREE.Mesh(legGeo, mat(0x2c3e50));
            legR.position.set(0.4, 0.6, 0);

            // Arms
            const armPiv = new THREE.Group(); armPiv.position.set(1, 2.6, 0); // Higher shoulder
            const arm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.5, 0.5), mat(0xe74c3c)); arm.position.y=-0.5;
            armPiv.add(arm);
            player.userData.arm = armPiv;

            // Hammer
            const hammer = new THREE.Group();
            const hHandle = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,2), mat(0x5D4037)); hHandle.position.y=1;
            const hHead = new THREE.Mesh(new THREE.BoxGeometry(1,0.6,1.5), mat(0x95a5a6)); hHead.position.set(0,2,0); hHead.rotation.x=1.57;
            hammer.add(hHandle, hHead); hammer.position.set(0, -1.5, 0.5); hammer.rotation.x = -1.5;
            hammer.visible = false;
            armPiv.add(hammer);
            player.userData.hammerModel = hammer;

            const lArm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.5, 0.5), mat(0xe74c3c)); 
            lArm.position.set(-1, 2.1, 0); // Higher left shoulder

            player.add(legL, legR, body, headGroup, armPiv, lArm);
        }

        // --- BOSS CREATION ---
        function createBoss(x, y, z) {
            boss = new THREE.Group();
            const mat = c => new THREE.MeshStandardMaterial({color:c});
            
            // Same Geometry as Player (Taller)
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 1.8, 0.8), mat(0x3498db)); // Blue Shirt
            body.position.y = 1.4;

            const headGroup = new THREE.Group();
            const headMesh = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), mat(0xf1c40f)); // Skin
            const hair = new THREE.Mesh(new THREE.BoxGeometry(1.3, 0.3, 1.3), mat(0xe67e22)); // Orange Hair
            hair.position.y = 0.65;
            headGroup.add(headMesh, hair);
            headGroup.position.y = 2.9;

            const legGeo = new THREE.BoxGeometry(0.5, 1.2, 0.5);
            const legL = new THREE.Mesh(legGeo, mat(0xe74c3c)); // Red Pants
            legL.position.set(-0.4, 0.6, 0);
            const legR = new THREE.Mesh(legGeo, mat(0xe74c3c)); // Red Pants
            legR.position.set(0.4, 0.6, 0);

            const armR = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.5, 0.5), mat(0x3498db)); 
            armR.position.set(1, 2.1, 0);

            const armL = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.5, 0.5), mat(0x3498db)); 
            armL.position.set(-1, 2.1, 0);

            boss.add(legL, legR, body, headGroup, armR, armL);
            boss.position.set(x, y, z);
            boss.userData = { type: 'boss' }; // tag
            scene.add(boss);
        }

        // ================= PHYSICS & INPUT =================

        function setupControls() {
            const setK = (k, v) => keys[k] = v;
            document.addEventListener('keydown', e => {
                if(e.key==='w'||e.key==='ArrowUp') setK('w',1);
                if(e.key==='s'||e.key==='ArrowDown') setK('s',1);
                if(e.key==='a'||e.key==='ArrowLeft') setK('a',1);
                if(e.key==='d'||e.key==='ArrowRight') setK('d',1);
                if(e.key===' ') performAction();
                if(e.key==='Shift' || e.key.toLowerCase()==='j') setK('jump',1);
            });
            document.addEventListener('keyup', e => {
                if(e.key==='w'||e.key==='ArrowUp') setK('w',0);
                if(e.key==='s'||e.key==='ArrowDown') setK('s',0);
                if(e.key==='a'||e.key==='ArrowLeft') setK('a',0);
                if(e.key==='d'||e.key==='ArrowRight') setK('d',0);
                if(e.key==='Shift' || e.key.toLowerCase()==='j') setK('jump',0);
            });

            const bindT = (id, k) => {
                const b = document.getElementById(id);
                b.addEventListener('touchstart', (e)=>{ e.preventDefault(); if(k==='action') performAction(); else keys[k]=1; });
                b.addEventListener('touchend', (e)=>{ e.preventDefault(); if(k!=='action') keys[k]=0; });
            };
            bindT('btn-up','w'); bindT('btn-down','s'); bindT('btn-left','a'); bindT('btn-right','d');
            bindT('btn-jump','jump'); bindT('btn-action','action');
        }

        function performAction() {
            if(isPaused) return;

            const arm = player.userData.arm;
            arm.rotation.x = -Math.PI / 2;
            setTimeout(() => arm.rotation.x = 0, 150);

            let actionDone = false;

            // BOSS COMBAT
            if(boss && bossHP > 0 && bossInvincibleTimer <= 0) {
                if(player.position.distanceTo(boss.position) < 4) {
                    bossHP--;
                    bossInvincibleTimer = 300; // 5 seconds (approx 60fps)
                    popText("HIT!");
                    
                    // UI Update
                    if(bossHP === 2) document.getElementById('heart3').classList.add('heart-dead');
                    if(bossHP === 1) document.getElementById('heart2').classList.add('heart-dead');
                    if(bossHP === 0) {
                        document.getElementById('heart1').classList.add('heart-dead');
                        scene.remove(boss);
                        createItem('finish', 0, 1.5, -12, 0x00FFFF);
                        popText("VICTORY!");
                    }
                    actionDone = true;
                }
            }
            if(actionDone) return;

            // Interactables
            for(let obj of interactables) {
                if(player.position.distanceTo(obj.position) < 4) {
                    if(obj.userData.type === 'lever' && !obj.userData.active) {
                        if(hasKey) {
                            obj.userData.active = true;
                            obj.userData.stick.rotation.x = 0.5;
                            obj.userData.stick.material.color.setHex(0x00FF00);
                            popText("ACTIVATED!");
                            if(guideArrow) { scene.remove(guideArrow); guideArrow=null; }
                            actionDone = true;
                        } else {
                            popText("NEED KEY!");
                            actionDone = true;
                        }
                    } else if(obj.userData.type === 'smashWall' && hasHammer) {
                        explode(obj.position, 0xD2B48C, 20);
                        scene.remove(obj);
                        popText("ESCAPED!");
                        if(guideArrow) { scene.remove(guideArrow); guideArrow=null; }
                        setTimeout(() => document.getElementById('win-screen').classList.remove('hidden'), 1000);
                        actionDone = true;
                    }
                }
            }
            if(actionDone) return;

            // Items
            for(let i=interactables.length-1; i>=0; i--) {
                let obj = interactables[i];
                if(obj.userData.pickup && player.position.distanceTo(obj.position) < 3.5) {
                    if(obj.userData.type === 'key') {
                        hasKey = true; popText("GOT KEY!");
                        // LEVEL 2 ARROW
                        spawnArrow(-35, 1, 0); // Above Lever (approx)
                    } else if (obj.userData.type === 'hammer') {
                        hasHammer = true; player.userData.hammerModel.visible = true; popText("GOT HAMMER!");
                        // LEVEL 1 ARROW
                        spawnArrow(0, 5, -20); // Above Wall
                    } else if (obj.userData.type === 'finish') {
                        document.getElementById('win-screen').classList.remove('hidden');
                        document.getElementById('boss-hud').classList.add('hidden');
                    }
                    scene.remove(obj); interactables.splice(i, 1);
                    return;
                }
            }

            // Breakables
            const hitRange = hasHammer ? 5 : 3.5;
            for(let i=breakables.length-1; i>=0; i--) {
                let obj = breakables[i];
                if(player.position.distanceTo(obj.position) < hitRange) {
                    explode(obj.position, obj.userData.type==='plant'?0x2ecc71:0x8B4513, 8);
                    if(obj.userData.special) createItem('hammer', obj.position.x, 1, obj.position.z, 0x333);
                    const lootCount = 5 + Math.floor(Math.random()*4);
                    for(let k=0; k<lootCount; k++) spawnCoin(obj.position.x, obj.position.y + 1, obj.position.z, 2, 0xC0C0C0, true);
                    const cIdx = colliders.indexOf(obj);
                    if(cIdx > -1) colliders.splice(cIdx, 1);
                    scene.remove(obj);
                    breakables.splice(i, 1);
                }
            }
        }

        function popText(msg) {
            const el = document.getElementById('interact-prompt');
            el.innerText = msg; el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 1500);
        }

        function updatePhysics() {
            let dx=0, dz=0;
            if(keys.w) dz -= SPEED; if(keys.s) dz += SPEED;
            if(keys.a) dx -= SPEED; if(keys.d) dx += SPEED;

            if(dx!==0) {
                const np = player.position.clone(); np.x += dx;
                if(!checkWall(np)) player.position.x += dx;
            }
            if(dz!==0) {
                const np = player.position.clone(); np.z += dz;
                if(!checkWall(np)) player.position.z += dz;
            }

            if(keys.jump && isGrounded) { playerVelY = JUMP_FORCE; isGrounded = false; }
            playerVelY += GRAVITY;
            player.position.y += playerVelY;

            const groundH = getGroundHeight(player.position);
            if(player.position.y <= groundH) {
                player.position.y = groundH;
                playerVelY = 0;
                isGrounded = true;
            } else { isGrounded = false; }

            if(dx!==0||dz!==0) player.rotation.y = Math.atan2(dx, dz);

            camera.position.set(player.position.x, player.position.y + 14, player.position.z + 22);
            camera.lookAt(player.position.x, player.position.y, player.position.z);
        }

        function checkWall(pos) {
            const pBox = new THREE.Box3().setFromCenterAndSize(new THREE.Vector3(pos.x, pos.y+1.5, pos.z), new THREE.Vector3(1,3,1));
            for(let c of colliders) {
                if(c.userData.isPlatform) continue; 
                if(pBox.intersectsBox(new THREE.Box3().setFromObject(c))) return true;
            }
            return false;
        }

        function getGroundHeight(pos) {
            let h = 0;
            for(let c of colliders) {
                const b = new THREE.Box3().setFromObject(c);
                if(pos.x > b.min.x && pos.x < b.max.x && pos.z > b.min.z && pos.z < b.max.z) {
                    if(pos.y >= b.max.y - 1) h = Math.max(h, b.max.y);
                }
            }
            return h;
        }

        function updateGameLogic() {
            // ARROW ANIMATION
            if(guideArrow) {
                guideArrow.rotation.y += 0.05;
                guideArrow.position.y += Math.sin(Date.now() * 0.005) * 0.05;
            }

            // BOSS LOGIC
            if(boss && bossHP > 0) {
                // Flash Red logic
                if(bossInvincibleTimer > 0) {
                    bossInvincibleTimer--;
                    // Flash effect
                    boss.visible = Math.floor(Date.now() / 100) % 2 === 0;
                    
                    // RUN AWAY
                    let dir = new THREE.Vector3().subVectors(boss.position, player.position).normalize();
                    let nextPos = boss.position.clone().add(dir.multiplyScalar(0.15));
                    
                    // Keep in bounds (approx -13 to 13)
                    if(Math.abs(nextPos.x) < 13 && Math.abs(nextPos.z) < 13) {
                        boss.position.copy(nextPos);
                    }
                    boss.lookAt(player.position); // Look at player while running back
                } else {
                    boss.visible = true;
                    // CHASE
                    let dist = boss.position.distanceTo(player.position);
                    if(dist > 2) {
                        let dir = new THREE.Vector3().subVectors(player.position, boss.position).normalize();
                        boss.position.add(dir.multiplyScalar(0.08)); // Slower chase
                        boss.lookAt(player.position);
                    } else {
                        // Attack Player
                        if(playerInvincibleTimer <= 0) {
                            playerInvincibleTimer = 60; // 1 sec
                            popText("OUCH!");
                        }
                    }
                }
            }
            
            // Player Hurt Flash
            if(playerInvincibleTimer > 0) {
                playerInvincibleTimer--;
                player.visible = Math.floor(Date.now() / 100) % 2 === 0;
            } else {
                player.visible = true;
            }

            // Menu Pads
            if(gameState === 'menu') {
                for(let pad of menuPads) {
                    if(player.position.distanceTo(pad.position) < 3) {
                        window.selectedLevel = pad.userData.id;
                        document.getElementById('popup-title').innerText = pad.userData.title;
                        document.getElementById('popup-desc').innerText = pad.userData.desc;
                        document.getElementById('level-popup').classList.remove('hidden');
                    }
                }
            }

            // Coin Physics
            for(let i=coins.length-1; i>=0; i--) {
                const c = coins[i];
                if(c.userData.physics) {
                    c.position.add(c.userData.velocity);
                    c.userData.velocity.y += GRAVITY; 
                    if(c.position.y < 0.2) {
                        c.position.y = 0.2;
                        c.userData.velocity.y *= -0.5; 
                        c.userData.velocity.x *= 0.9;  
                        c.userData.velocity.z *= 0.9;
                    }
                    if(c.userData.velocity.length() > 0.05) {
                        c.rotation.x += 0.1; c.rotation.z += 0.1;
                    } else {
                        c.userData.physics = false;
                        c.rotation.set(0,0,0); c.rotation.x = 1.57;
                    }
                } else { c.rotation.y += 0.05; }

                if(player.position.distanceTo(c.position) < 2.5) {
                    score += c.userData.value;
                    document.getElementById('score').innerText = score;
                    localStorage.setItem('blockyScoreV6', score);
                    scene.remove(c); coins.splice(i, 1);
                }
            }

            // Platform
            const lever = interactables.find(x => x.userData.type === 'lever');
            if(lever && lever.userData.active) {
                const plat = colliders.find(x => x.userData.isPlatform);
                if(plat) {
                    plat.position.y = 5 + Math.sin(Date.now() * 0.002) * 4; 
                    if(plat.position.z > -25) plat.position.z = -25; 
                }
            }

            // Particles
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.position.add(p.userData.vel);
                p.userData.vel.y -= 0.02;
                p.rotation.x += 0.1;
                if(p.position.y < -5) { scene.remove(p); particles.splice(i,1); }
            }
        }

        function explode(pos, col, n) {
            for(let i=0; i<n; i++) {
                const m = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,0.3), new THREE.MeshBasicMaterial({color:col}));
                m.position.copy(pos);
                m.userData.vel = new THREE.Vector3((Math.random()-0.5), Math.random(), (Math.random()-0.5));
                scene.add(m); particles.push(m);
            }
        }

        function togglePause() {
            if(gameState==='menu') return;
            isPaused = !isPaused;
            document.getElementById('pause-screen').classList.toggle('hidden', !isPaused);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!isPaused) {
                updatePhysics();
                updateGameLogic();
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
